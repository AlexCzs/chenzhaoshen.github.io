# Object-C运行时

# runtime运行时

```
1.什么是运行时
1> 运行时是一套存C语言的API(存C语言库)


2> 利用运行时,可以做很多底层的操作,比如
* clang -rewrite-objc xxx.m

3> 编译器最终都会讲OC代码 转化 为运行时代码
* 动态添加对象的成员变量和成员方法
* 动态交换两个方法的实现(特别是交换系统自带的方法)
* 获得某个类的所有成员方法,所有成员变量
```

### 2.如何应用运行时2

```
1> 将某些OC代码转为运行时代码:探究底层,比如block的实现原理
2> 拦截系统自带的方法调用,比如拦截imageName:,viewDidLoad,alloc(什么是iOS的SWizzle,黑魔法,巫术)
3> 实现字典和模型的自动转换
4> 实现分类增加属性(每个对象的属性互补干扰)
5> 实现NSCoding属性的自动归档和自动解档
```

### 3.运行时常用的函数

```
1> <objc/runtime.h>
* Method class_getClassMethod(Class cls,SEL name)
获得某个类的类方法

* Method class_getInstanceMethod(Class cls,SEL name)
获得某个类的对象方法

* void method_exchangeImplementations(Method m1, Method m2) 
交换2个方法的实现(重点,iOS 中的黑魔法Swizzle)

* void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy)
将值value根对象object关联起来(将值value存贮到对象object中)
参数key: 将来可以通过key去除这个存储的值
参数policy: 存贮策略(assign,copy,retain)

* id objc_getAssociatedObject(id object,sonst void *key)
利用参数key将对象object中存储的对应值取出来

* Ivar *class_copyIvarList(Class cls, unsigned int *outCount) 
获得某各类的所有成员变量(outCount会返回所有成员变量的总数)

* const char *ivar_getName(Ivar v) 
获得成员变量的名字

* const char *ivar_getTypeEncoding(Ivar v) 
获得成员变量的类型

* void	 free(void *);
释放内存
(当C语言函数名中包含了copy,create,retai,new等词语,都需要在最后释放资源)



2> <objc/message.h>
* void objc_msgSend(void)
给某个对象发送某个消息
```

------

### 代码实现

##### 动态交换两个方法的实现(特别是交换系统自带的方法)

```
//交换方法实现
    Method m1 = class_getClassMethod([Person class], @selector(run));
    Method m2 = class_getClassMethod([Person class], @selector(study));
    method_exchangeImplementations(m1, m2);
```

##### 交换方法实现,兼容版本具体应用

```
#import "UIImage+Extension.h"
#import <objc/runtime.h>

@implementation UIImage (Extension)
//交换方法
+(void)load{
    Method m1 = class_getClassMethod([UIImage class], @selector(imageNamed:));
    Method m2 = class_getClassMethod([UIImage class], @selector(ac_imageNamed:));
    method_exchangeImplementations(m1, m2);
}
+(UIImage *)ac_imageNamed:(NSString *)name{
    double version = [[[UIDevice currentDevice] systemVersion]doubleValue];
    if (version >= 7.0) {
        name = [NSString stringWithFormat:@"%@_iOS7",name];
    }
    return [UIImage ac_imageNamed:name];
}
@end
```

##### 给分类增加属性

```
#import <Foundation/Foundation.h>

@interface NSObject (Extension)
@property(nonatomic,copy)NSString *name;
@end


#import "NSObject+Extension.h"
#import <objc/runtime.h>


@implementation NSObject (Extension)


char NameKey;
-(void)setName:(NSString *)name{
    
    objc_setAssociatedObject(self, &NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

-(NSString *)name{
    return  objc_getAssociatedObject(self, &NameKey);
}


@end
```

##### 获取类的所有成员变量

```
unsigned int outCount = 0;
    //获得Dog类的所有成员变量
    Ivar *ivars = class_copyIvarList([Dog class], &outCount);
    // 遍历所有的成员变量
    for (int i = 0; i < outCount; i++) {
        Ivar ivar = ivars[i];
        const char *name =  ivar_getName(ivar);
        const char *type = ivar_getTypeEncoding(ivar);
        NSLog(@"%s %s",name,type);
    }
    //释放内存
    free(ivars);
    
    NSLog(@"%zd",outCount);
```

##### 运行KVC时归档解档

```
#import "Dog.h"
#import <objc/runtime.h>
@interface Dog : NSObject<NSCoding>
@property (nonatomic, copy) NSString *name;
@property (nonatomic, assign) int age;
@property (nonatomic, assign) double height;
@property (nonatomic, assign) double weight;
@property (nonatomic, assign) double aaa;
@property (nonatomic, assign) double bbb;
@property (nonatomic, assign) double ccc;
@end

#import "Dog.h"
#import <objc/runtime.h>
@implementation Dog

/*
 这个数据的成员变量,不会被归档和解档
 */
-(NSArray *)ignoredNames{
    return @[@"_aaa",@"_bbb",@"_ccc"];
}

/// 从文件中读取对象时会调用这个方法(说明需要读取的属性)
-(instancetype)initWithCoder:(NSCoder *)aDecoder{
    
    if (self = [super init]) {
        
        //用来存储成员变量的数量
        unsigned int outCount = 0;
        
        //获得Dog类的所有成员变量
        Ivar *ivars = class_copyIvarList([self class], &outCount);
        
        // 遍历所有的成员变量
        for (int i = 0; i < outCount; i++) {
            // 取出i位置对应的成员变量
            Ivar ivar = ivars[i];
            
            NSString *key =  [NSString stringWithUTF8String:ivar_getName(ivar)];
            //忽略解档对象
            if ([[self ignoredNames] containsObject:key])
                continue;
            //获得key对应的值
            id value = [aDecoder decodeObjectForKey:key];
            
            //设置到成员变量上
            [self setValue:value forKeyPath:key];
        }
        
        //释放内存
        free(ivars);

    }
    return self;
    

    
}

/// 将对象写入文件时会调用这个方法(说明哪个属性需要存储)
-(void)encodeWithCoder:(NSCoder *)aCoder{
    
    //用来存储成员变量的数量
    unsigned int outCount = 0;
    //获得Dog类的所有成员变量
    Ivar *ivars = class_copyIvarList([self class], &outCount);
    // 遍历所有的成员变量
    for (int i = 0; i < outCount; i++) {
        Ivar ivar = ivars[i];
        NSString *key =  [NSString stringWithUTF8String:ivar_getName(ivar)];
        //忽略归档对象
        if ([[self ignoredNames] containsObject:key])
            continue;
        id value = [self valueForKeyPath:key];
        
        [aCoder encodeObject:value forKey:key];
    }
    
    //释放内存
    free(ivars);
}

//viewController点击方法
-(void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event{
    
    Dog *dog1 = [[Dog alloc]init];
    dog1.age = 20;
    dog1.height = 1.55;
    dog1.name = @"wangcai";
    dog1.weight = 50;
    //将dog归档到桌面
    [NSKeyedArchiver archiveRootObject:dog1 toFile:@"/Users/Chenzhaoshen/Desktop/dog.hm"];
    
    //解档
    Dog *dog = [NSKeyedUnarchiver unarchiveObjectWithFile:@"/Users/Chenzhaoshen/Desktop/dog.hm"];
    NSLog(@"%@,%d,%f,%f",dog.name,dog.age,dog.height,dog.weight);
    
}
```

------

### 懒加载

```
* 当某个类或者分类加载进内存时,会调用1次
+(void)load方法
* 当某个类或者分类初始化时,会调用1次
+(void)initialize方法
```

### 解决项目配置的大部分报错问题

```
1.先尝试删除Xcode编译后的缓存
Xcode -> Preferences -> Locations -> Derived Data

2.清除Xcod的用户操作数据
项目名.xcoderproj --> 点击 --> 显示包内容 --> xcuserdata文件夹 --> 删除

3.打开project.pbxproj文件,查看是否有冗余内容,替换为新内容

4.打开project.xcworkspace文件,查看是否有冗余内容,替换为新内容

5.stackoverflow.com - IT问答网站(全英文)
* 搜索内容:报错信息(不能太长,不能包含项目特用的东西,比如项目名称)
* Xcode File not found: DerivedData
* iOS File not found:DerivedData
* Objective-C xxx
```